---
# Manage password salts for deterministic bcrypt hashing
# This task file ensures all required salts exist and generates missing ones
# Usage:
#   - name: Manage password salts
#     ansible.builtin.include_tasks: ../tasks/manage_password_salts.yml
#     vars:
#       required_salt_names:
#         - argocd_salt
#         - adguard_salt

- name: Set salt file path
  ansible.builtin.set_fact:
    salt_file_path: '{{ playbook_dir }}/../.ansible-password-salts.yml'
  run_once: true

- name: Check if password salts file exists
  ansible.builtin.set_fact:
    salts_file_exists: "{{ lookup('file', salt_file_path, errors='ignore') is not none }}"
  run_once: true

- name: Load existing password salts
  ansible.builtin.set_fact:
    password_salts: "{{ lookup('file', salt_file_path) | from_yaml }}"
  when: salts_file_exists
  run_once: true

- name: Initialize password_salts if file doesn't exist
  ansible.builtin.set_fact:
    password_salts: {}
  when: not salts_file_exists
  run_once: true

- name: Check for missing salts
  ansible.builtin.set_fact:
    missing_salts: '{{ required_salt_names | difference(password_salts.keys() | list) }}'
  run_once: true

- name: Generate missing salts
  ansible.builtin.set_fact:
    password_salts: "{{ password_salts | combine({item: lookup('password', '/dev/null chars=ascii_letters,digits length=22')}) }}"
  loop: '{{ missing_salts }}'
  when: missing_salts | length > 0
  run_once: true

- name: Save updated salts to file
  ansible.builtin.copy:
    content: |
      ---
      # Ansible password salts - DO NOT COMMIT TO GIT
      # Generated/Updated on: {{ ansible_date_time.iso8601 }}
      {{ password_salts | to_nice_yaml }}
    dest: '{{ salt_file_path }}'
    mode: '0600'
  delegate_to: localhost
  become: false
  when: missing_salts | length > 0
  run_once: true
