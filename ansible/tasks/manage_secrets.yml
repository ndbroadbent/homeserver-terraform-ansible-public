---
# Generic secrets hash management for idempotent secret handling
# This file manages secret hashes to prevent unnecessary updates

- name: Create Ansible facts directory
  ansible.builtin.file:
    path: /etc/ansible/facts.d
    state: directory
    mode: '0755'

- name: Check if secrets hash file exists
  ansible.builtin.stat:
    path: /etc/ansible/facts.d/secrets.json
  register: secrets_hash_file

- name: Load previously stored secret hashes (if any)
  ansible.builtin.slurp:
    src: /etc/ansible/facts.d/secrets.json
  register: secrets_hash_content
  when: secrets_hash_file.stat.exists

- name: Parse existing secret hashes
  ansible.builtin.set_fact:
    existing_secrets: '{{ (secrets_hash_content.content | b64decode | from_json) | default({}) }}'
  when: secrets_hash_file.stat.exists
  no_log: true

- name: Set empty secrets if no file exists
  ansible.builtin.set_fact:
    existing_secrets: {}
  when: not secrets_hash_file.stat.exists
  no_log: true
