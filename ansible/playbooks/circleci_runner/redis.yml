---
- name: Create Redis values.yaml
  ansible.builtin.copy:
    content: |
      architecture: standalone
      auth:
        enabled: false
      master:
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "250m"
        persistence:
          enabled: true
          storageClass: "openebs-zfs-circleci"
          accessMode: ReadWriteOnce
          size: 10Gi
      service:
        type: ClusterIP
        port: 6379
      metrics:
        enabled: false
      commonConfiguration: |-
        save ""
        maxmemory 200mb
        maxmemory-policy allkeys-lru
        tcp-keepalive 60
        timeout 0
        # Expire job status keys after 7 days
        # This will be overridden by explicit TTL in CircleCI commands
    dest: /etc/circleci-runner/redis-values.yaml
    mode: '0644'

- name: Deploy Redis
  kubernetes.core.helm:
    name: redis
    chart_ref: bitnami/redis
    release_namespace: redis
    create_namespace: true
    values_files:
      - /etc/circleci-runner/redis-values.yaml
    state: present
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml

- name: Wait for Redis deployment
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: StatefulSet
    namespace: redis
    name: redis-master
    kubeconfig: /etc/rancher/k3s/k3s.yaml
  register: redis_deployment
  until: redis_deployment.resources | length > 0 and (redis_deployment.resources[0].status.readyReplicas | default(0)) > 0
  retries: 30
  delay: 10
